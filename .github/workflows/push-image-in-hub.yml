name: Build, Test, Scan and Push Docker Image

on:
  push:
    # branches:
    #   - main
    tags:
      - "v*" # Trigger on version tags like v1.0.0

env:
  WORKING_DIR: ./ # Define once for all jobs
  IMAGE_NAME: sa2avroo/quran-api
  REGISTRY: ghcr.io
  IMAGE_NAME_GITHUB: ${{ github.repository }}/quran-api

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ·ï¸ Get version from package.json
        id: get_version
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Using version: ${VERSION}"

  install:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ§° Set up Node.js with caching
        uses: actions/setup-node@v3
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: ${{ env.WORKING_DIR }}/package-lock.json

      - name: ğŸ“¦ Install Dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci --legacy-peer-deps

  build-code:
    needs: [setup, install]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ—ï¸ Build Node.js app
        working-directory: ${{ env.WORKING_DIR }}
        run: npm run build

  build-image:
    needs: [setup, build-code]
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ƒï¸ Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: ğŸ³ Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.WORKING_DIR }}
          push: false
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.version }}
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_GITHUB }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_GITHUB }}:${{ needs.setup.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_GITHUB }}:${{ github.sha }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          load: true

      - name: ğŸ”„ Update Docker cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: ğŸ“¦ Save Docker Images
        run: |
          docker save ${{ env.IMAGE_NAME }}:latest -o image_dockerhub_latest.tar
          docker save ${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.version }} -o image_dockerhub_versioned.tar
          docker save ${{ env.IMAGE_NAME }}:${{ github.sha }} -o image_dockerhub_sha.tar

          docker save ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_GITHUB }}:latest -o image_ghcr_latest.tar
          docker save ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_GITHUB }}:${{ needs.setup.outputs.version }} -o image_ghcr_versioned.tar
          docker save ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_GITHUB }}:${{ github.sha }} -o image_ghcr_sha.tar

      - name: ğŸ“¤ Upload Images
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: |
            image_dockerhub_latest.tar
            image_dockerhub_versioned.tar
            image_dockerhub_sha.tar
            image_ghcr_latest.tar
            image_ghcr_versioned.tar
            image_ghcr_sha.tar
          retention-days: 1

  scan:
    needs: [setup, build-image]
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Download Images
        uses: actions/download-artifact@v4
        with:
          name: docker-images

      - name: ğŸ›¡ï¸ Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo gpg --dearmor -o /usr/share/keyrings/trivy.gpg
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update -y
          sudo apt-get install -y trivy

      - name: ğŸ” Scan Docker images
        run: |
          docker load -i image_dockerhub_latest.tar
          docker load -i image_dockerhub_versioned.tar
          docker load -i image_dockerhub_sha.tar

          trivy image --exit-code 1 --severity HIGH,CRITICAL --no-progress ${{ env.IMAGE_NAME }}:latest
          trivy image --exit-code 1 --severity HIGH,CRITICAL --no-progress ${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.version }}
          trivy image --exit-code 1 --severity HIGH,CRITICAL --no-progress ${{ env.IMAGE_NAME }}:${{ github.sha }}

  push-to-docker-hub:
    needs: [setup, build-image, scan]
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ“¥ Download Images
        uses: actions/download-artifact@v4
        with:
          name: docker-images

      - name: ğŸ“¦ Load Docker Images
        run: |
          docker load -i image_dockerhub_latest.tar
          docker load -i image_dockerhub_versioned.tar
          docker load -i image_dockerhub_sha.tar

      - name: ğŸ“¤ Push Docker Hub images
        run: |
          docker push ${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.version }}
          docker push ${{ env.IMAGE_NAME }}:${{ github.sha }}

  push-to-github-registry:
    needs: [setup, build-image, scan]
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¥ Download Images
        uses: actions/download-artifact@v4
        with:
          name: docker-images

      - name: ğŸ“¦ Load GitHub Images
        run: |
          docker load -i image_ghcr_latest.tar
          docker load -i image_ghcr_versioned.tar
          docker load -i image_ghcr_sha.tar

      - name: ğŸ“¤ Push GitHub Registry images
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_GITHUB }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_GITHUB }}:${{ needs.setup.outputs.version }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_GITHUB }}:${{ github.sha }}


# ==================================

# git tag v1.1.4
# git push origin v1.1.4 --tags

# ==================================
